<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Email - SelfEval</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container">
    <div class="row justify-content-center mt-5">
      <div class="col-md-5">
        <div class="card shadow">
          <div class="card-body p-5 text-center">
            <div id="loading">
              <div class="spinner-border text-primary mb-3"></div>
              <h4>Verifying your email...</h4>
              <p class="text-muted">Please wait while we verify your email address.</p>
            </div>

            <div id="success" style="display: none;">
              <div class="text-success mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>
              </div>
              <h4 class="text-success">Email Verified!</h4>
              <p class="text-muted">Your email has been verified successfully. You can now sign in to your account.</p>
              <a href="/signin" class="btn btn-primary mt-3">Sign In</a>
            </div>

            <div id="error" style="display: none;">
              <div class="text-danger mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                </svg>
              </div>
              <h4 class="text-danger">Verification Failed</h4>
              <p class="text-muted" id="error-message">This verification link is invalid or has expired.</p>
              <div class="mt-4">
                <p class="text-muted">Need a new verification link?</p>
                <form id="resend-form" class="d-inline">
                  <div class="input-group mb-3">
                    <input type="email" class="form-control" id="resend-email" placeholder="Enter your email" required>
                    <button class="btn btn-outline-primary" type="submit" id="resend-btn">Resend</button>
                  </div>
                </form>
                <div id="resend-message"></div>
              </div>
              <hr class="my-4">
              <a href="/signin" class="btn btn-secondary">Back to Sign In</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');

      if (!token) {
        showError('No verification token provided.');
        return;
      }

      try {
        const res = await fetch('/api/auth/verify-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        const data = await res.json();

        if (res.ok) {
          showSuccess();
        } else {
          showError(data.error || 'Verification failed');
        }
      } catch (error) {
        showError('Network error. Please try again.');
      }
    }

    function showSuccess() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('success').style.display = 'block';
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error-message').textContent = message;
    }

    document.getElementById('resend-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('resend-email').value;
      const btn = document.getElementById('resend-btn');
      const messageDiv = document.getElementById('resend-message');

      btn.disabled = true;
      btn.textContent = 'Sending...';
      messageDiv.innerHTML = '';

      try {
        const res = await fetch('/api/auth/resend-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();

        if (res.ok) {
          messageDiv.innerHTML = '<div class="alert alert-success mt-2">Verification email sent! Please check your inbox.</div>';
        } else {
          messageDiv.innerHTML = '<div class="alert alert-danger mt-2">' + (data.error || 'Failed to send email') + '</div>';
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-danger mt-2">Network error. Please try again.</div>';
      }

      btn.disabled = false;
      btn.textContent = 'Resend';
    });

    init();
  </script>
</body>
</html>
