<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - SelfEval</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">SelfEval</a>
      <div class="navbar-nav ms-auto" id="nav-items">
        <a class="nav-link" href="/">Courses</a>
        <a class="nav-link" href="/signin">Sign In</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">My Profile</h4>
          </div>
          <div class="card-body">
            <div id="profile-content">
              <p class="text-center">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Change Password Card -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">Change Password</h5>
          </div>
          <div class="card-body">
            <form id="password-form">
              <div class="mb-3">
                <label for="current-password" class="form-label">Current Password</label>
                <input type="password" class="form-control" id="current-password" required>
              </div>
              <div class="mb-3">
                <label for="new-password" class="form-label">New Password</label>
                <input type="password" class="form-control" id="new-password" required minlength="6">
              </div>
              <div class="mb-3">
                <label for="confirm-password" class="form-label">Confirm New Password</label>
                <input type="password" class="form-control" id="confirm-password" required>
              </div>
              <button type="submit" class="btn btn-primary">Update Password</button>
            </form>
            <div id="password-message" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    let currentUser = null;

    async function init() {
      await updateNavbar();
      currentUser = await getCurrentUser();

      if (!currentUser) {
        window.location.href = '/signin';
        return;
      }

      renderProfile();
      setupEventListeners();
    }

    function renderProfile() {
      const content = document.getElementById('profile-content');
      content.innerHTML = `
        <form id="profile-form">
          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" value="${escapeHtml(currentUser.name)}" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" value="${escapeHtml(currentUser.email)}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <input type="text" class="form-control" value="${currentUser.role}" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">Member Since</label>
            <input type="text" class="form-control" value="${new Date(currentUser.created_at).toLocaleDateString()}" disabled>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
        <div id="profile-message" class="mt-3"></div>
      `;

      document.getElementById('profile-form').addEventListener('submit', updateProfile);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function updateProfile(e) {
      e.preventDefault();

      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const messageDiv = document.getElementById('profile-message');

      try {
        const res = await fetch('/api/auth/me', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to update profile');
        }

        messageDiv.innerHTML = '<div class="alert alert-success">Profile updated successfully!</div>';
        currentUser = data.user;
        await updateNavbar();
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
      }
    }

    function setupEventListeners() {
      document.getElementById('password-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const messageDiv = document.getElementById('password-message');

        if (newPassword !== confirmPassword) {
          messageDiv.innerHTML = '<div class="alert alert-danger">New passwords do not match</div>';
          return;
        }

        try {
          const res = await fetch('/api/auth/password', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Failed to change password');
          }

          messageDiv.innerHTML = '<div class="alert alert-success">Password changed successfully!</div>';
          document.getElementById('password-form').reset();
        } catch (error) {
          messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
      });
    }

    init();
  </script>
</body>
</html>
