<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - SelfEval</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">SelfEval</a>
      <div class="navbar-nav ms-auto" id="nav-items">
        <!-- Dynamically populated by updateNavbar() -->
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Administration</h1>
      <div id="stats-badge" class="text-muted"></div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-panel" type="button" role="tab">
          Users
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-panel" type="button" role="tab">
          Analytics
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="disputes-tab" data-bs-toggle="tab" data-bs-target="#disputes-panel" type="button" role="tab">
          Disputes <span id="admin-disputes-badge" class="badge bg-warning text-dark ms-1" style="display: none;">0</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cache-tab" data-bs-toggle="tab" data-bs-target="#cache-panel" type="button" role="tab">
          Cache
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">
          Settings
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Users Tab -->
      <div class="tab-pane fade show active" id="users-panel" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">All Users</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table">
                  <tr>
                    <td colspan="6" class="text-center py-4">Loading users...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Course Performance Tab -->
      <div class="tab-pane fade" id="performance-panel" role="tabpanel">
        <div id="course-performance-container">
          <p class="text-center py-4">Loading course performance...</p>
        </div>
      </div>

      <!-- Disputes Tab -->
      <div class="tab-pane fade" id="disputes-panel" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Learner Disputes</h5>
            <select id="admin-dispute-filter" class="form-select form-select-sm" style="width: auto;">
              <option value="">All Disputes</option>
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="disapproved">Disapproved</option>
            </select>
          </div>
          <div class="card-body">
            <p class="text-muted small mb-3">
              Review disputes submitted by learners who believe the AI evaluation was incorrect.
              You can approve (triggers re-evaluation) or disapprove with feedback.
            </p>
            <div id="admin-disputes-list">
              <p class="text-center py-4">Loading disputes...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Cache Management Tab -->
      <div class="tab-pane fade" id="cache-panel" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Question Cache Management</h5>
            <button class="btn btn-danger btn-sm" onclick="clearAllCache()">Clear All Cache</button>
          </div>
          <div class="card-body">
            <p class="text-muted small mb-3">
              AI-generated questions are cached and reused across learners to reduce API calls.
              Questions are served from cache if the learner hasn't answered them before.
            </p>

            <!-- Cache Stats -->
            <div class="row g-3 mb-4" id="cache-stats">
              <div class="col-md-3">
                <div class="card bg-light text-center">
                  <div class="card-body py-3">
                    <h4 class="mb-0" id="cache-total">-</h4>
                    <small class="text-muted">Total Cached</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light text-center">
                  <div class="card-body py-3">
                    <h4 class="mb-0" id="cache-courses">-</h4>
                    <small class="text-muted">Courses</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light text-center">
                  <div class="card-body py-3">
                    <h4 class="mb-0" id="cache-topics">-</h4>
                    <small class="text-muted">Topics</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light text-center">
                  <div class="card-body py-3">
                    <h4 class="mb-0" id="cache-types">-</h4>
                    <small class="text-muted">Question Types</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label small">Course</label>
                <select id="cache-filter-course" class="form-select form-select-sm">
                  <option value="">All Courses</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small">Topic</label>
                <select id="cache-filter-topic" class="form-select form-select-sm">
                  <option value="">All Topics</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small">Question Type</label>
                <select id="cache-filter-type" class="form-select form-select-sm">
                  <option value="">All Types</option>
                  <option value="mcq">Multiple Choice</option>
                  <option value="truefalse">True/False</option>
                  <option value="concept">Concept</option>
                  <option value="comparison">Comparison</option>
                  <option value="fillblank">Fill Blank</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetCacheFilters()">Reset</button>
                <span class="text-muted small" id="cache-filter-count"></span>
              </div>
            </div>

            <!-- Cached Questions Table -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Course</th>
                    <th>Topic</th>
                    <th>Type</th>
                    <th>Question Preview</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="cache-table">
                  <tr>
                    <td colspan="7" class="text-center py-4">Loading cache...</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <label class="small me-2">Per page:</label>
                <select id="cache-page-size" class="form-select form-select-sm d-inline-block" style="width: auto;">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <nav>
                <ul class="pagination pagination-sm mb-0" id="cache-pagination"></ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-pane fade" id="settings-panel" role="tabpanel">
        <div class="row">
          <div class="col-lg-8">
            <!-- Email Verification Settings -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Email Verification</h5>
              </div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="require-email-verification" style="transform: scale(1.3);">
                  <label class="form-check-label ms-2" for="require-email-verification">
                    <strong>Require email verification for new signups</strong>
                  </label>
                </div>
                <p class="text-muted small mb-3">
                  When enabled, new users must verify their email address before they can sign in.
                  A verification link will be sent to their email after registration.
                </p>
                <button class="btn btn-primary btn-sm" id="save-email-settings-btn">Save Email Settings</button>
                <span id="email-settings-status" class="ms-2"></span>

                <hr class="my-4">

                <h6>SMTP Configuration</h6>
                <p class="text-muted small">Configure SMTP settings in your <code>.env</code> file:</p>
                <pre class="bg-light p-3 rounded small"><code>SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
SMTP_FROM=noreply@example.com
APP_URL=http://localhost:3000</code></pre>
                <p class="text-muted small">Without SMTP configuration, verification emails will be logged to the server console.</p>
              </div>
            </div>

            <!-- Interview Requirements Settings -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Interview Settings</h5>
              </div>
              <div class="card-body">
                <h6>Access Requirements</h6>
                <p class="text-muted small mb-3">
                  Set minimum requirements learners must meet before they can access the Interview feature.
                  Set to 0 to disable the requirement.
                </p>

                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label for="interview-min-questions" class="form-label">Minimum Practice Questions (Per Topic)</label>
                    <input type="number" class="form-control" id="interview-min-questions" min="0" max="100" value="0">
                    <div class="form-text">Learners must answer at least this many questions <strong>in each topic</strong> before accessing interviews</div>
                  </div>
                  <div class="col-md-6">
                    <label for="interview-min-score" class="form-label">Minimum Average Score (%)</label>
                    <input type="number" class="form-control" id="interview-min-score" min="0" max="100" value="0">
                    <div class="form-text">Learners must achieve at least this average score in practice</div>
                  </div>
                </div>

                <hr class="my-3">

                <h6>Interview Limits</h6>
                <p class="text-muted small mb-3">
                  Control interview session behavior and usage limits.
                </p>

                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="interview-daily-limit" class="form-label">Daily Question Limit</label>
                    <input type="number" class="form-control" id="interview-daily-limit" min="1" max="500" value="50">
                    <div class="form-text">Maximum interview questions a learner can answer per day</div>
                  </div>
                  <div class="col-md-6">
                    <div class="alert alert-info small mb-0 mt-4">
                      <strong>Auto-end on skips:</strong> Interview sessions automatically end if a learner skips 3 questions.
                    </div>
                  </div>
                </div>

                <button class="btn btn-primary btn-sm" id="save-interview-settings-btn">Save Interview Settings</button>
                <span id="interview-settings-status" class="ms-2"></span>
              </div>
            </div>

            <!-- Learner Features Settings -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Learner Features</h5>
              </div>
              <div class="card-body">
                <h6>History Management</h6>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="allow-clear-history" style="transform: scale(1.3);">
                  <label class="form-check-label ms-2" for="allow-clear-history">
                    <strong>Allow learners to clear their Q&A history</strong>
                  </label>
                </div>
                <p class="text-muted small mb-3">
                  When enabled, learners can clear their own Q&A history from the course history tab.
                  When disabled, this option is hidden from learners.
                </p>
                <button class="btn btn-primary btn-sm" id="save-learner-features-btn">Save Learner Features</button>
                <span id="learner-features-status" class="ms-2"></span>
              </div>
            </div>

            <!-- Question Types Settings -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Question Types</h5>
              </div>
              <div class="card-body">
                <h6>Learner Selection</h6>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="allow-question-type-selection" style="transform: scale(1.3);">
                  <label class="form-check-label ms-2" for="allow-question-type-selection">
                    <strong>Allow learners to select question type</strong>
                  </label>
                </div>
                <p class="text-muted small mb-4">
                  When disabled, learners will always get random question types. When enabled, they can choose specific types from a dropdown.
                </p>

                <hr>

                <h6>Enabled Question Types</h6>
                <p class="text-muted small mb-3">
                  Select which question types are available. Random selection will pick from these enabled types.
                </p>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check mb-2">
                      <input class="form-check-input question-type-check" type="checkbox" value="mcq" id="qtype-mcq" checked>
                      <label class="form-check-label" for="qtype-mcq">Multiple Choice</label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input question-type-check" type="checkbox" value="truefalse" id="qtype-truefalse" checked>
                      <label class="form-check-label" for="qtype-truefalse">True or False</label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input question-type-check" type="checkbox" value="fillblank" id="qtype-fillblank" checked>
                      <label class="form-check-label" for="qtype-fillblank">Fill in the Blank</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check mb-2">
                      <input class="form-check-input question-type-check" type="checkbox" value="concept" id="qtype-concept" checked>
                      <label class="form-check-label" for="qtype-concept">Concept Explanation</label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input question-type-check" type="checkbox" value="comparison" id="qtype-comparison" checked>
                      <label class="form-check-label" for="qtype-comparison">Comparison</label>
                    </div>
                  </div>
                </div>
                <div class="alert alert-info small mt-3 mb-3">
                  <strong>Note:</strong> At least one question type must be enabled. These types are used for random selection and (if allowed) learner selection.
                </div>
                <button class="btn btn-primary btn-sm" id="save-question-types-btn">Save Question Types</button>
                <span id="question-types-status" class="ms-2"></span>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">AI Model Configuration</h5>
              </div>
              <div class="card-body">
                <div class="mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <span class="me-2">Current Model:</span>
                    <span class="badge bg-primary fs-6" id="current-model-badge">Loading...</span>
                  </div>
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold">Select AI Model</label>
                  <p class="text-muted small mb-3">Choose the AI model to use for generating questions and evaluating answers.</p>

                  <div id="model-options">
                    <p class="text-muted">Loading available models...</p>
                  </div>
                </div>

                <div class="alert alert-info">
                  <strong>Note:</strong> Different models have different capabilities and costs.
                  <ul class="mb-0 mt-2">
                    <li><strong>Groq models</strong> - Fast and free, good for most use cases</li>
                    <li><strong>Claude Haiku</strong> - Fast, affordable, good balance of speed and quality</li>
                    <li><strong>Claude Sonnet</strong> - Higher quality responses, moderate cost</li>
                    <li><strong>Claude Opus</strong> - Highest quality, best for complex evaluations</li>
                  </ul>
                </div>

                <button class="btn btn-primary" id="save-settings-btn" disabled>
                  Save Settings
                </button>
                <span id="settings-save-status" class="ms-3"></span>
              </div>
            </div>

            <!-- User API Keys Configuration -->
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">User API Keys</h5>
              </div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="require-user-api-keys" style="transform: scale(1.3);">
                  <label class="form-check-label ms-2" for="require-user-api-keys">
                    <strong>Require users to configure their own API keys</strong>
                  </label>
                </div>
                <p class="text-muted small mb-3">
                  When enabled, users must configure their own API keys (Groq or Anthropic) in their settings before they can generate questions or use interviews.
                  This is useful to distribute API costs to users or when you don't have system-wide API keys.
                </p>
                <div class="alert alert-warning small mb-3">
                  <strong>Important:</strong> If enabled and no system API keys are configured, users without their own API keys won't be able to use AI features.
                </div>
                <button class="btn btn-primary btn-sm" id="save-user-api-settings-btn">Save User API Settings</button>
                <span id="user-api-settings-status" class="ms-2"></span>
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">System API Keys</h5>
              </div>
              <div class="card-body">
                <p class="text-muted">System-wide API keys are configured via environment variables in the <code>.env</code> file. These are used as fallback when user API keys are not required or not configured.</p>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Provider</th>
                        <th>Environment Variable</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="api-keys-status">
                      <tr>
                        <td>Groq</td>
                        <td><code>GROQ_API_KEY</code></td>
                        <td><span class="badge bg-secondary">Checking...</span></td>
                      </tr>
                      <tr>
                        <td>Anthropic (Claude)</td>
                        <td><code>ANTHROPIC_API_KEY</code></td>
                        <td><span class="badge bg-secondary">Checking...</span></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="edit-user-form">
            <input type="hidden" id="edit-user-id">
            <div class="mb-3">
              <label for="edit-name" class="form-label">Name</label>
              <input type="text" class="form-control" id="edit-name" required>
            </div>
            <div class="mb-3">
              <label for="edit-email" class="form-label">Email</label>
              <input type="email" class="form-control" id="edit-email" required>
            </div>
            <div class="mb-3">
              <label for="edit-role" class="form-label">Role</label>
              <select class="form-select" id="edit-role">
                <option value="learner">Learner</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="edit-enabled">
                <label class="form-check-label" for="edit-enabled">Account Enabled</label>
              </div>
              <small class="text-muted">Disabled users cannot sign in</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-user-btn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Performance Modal -->
  <div class="modal fade" id="viewPerformanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Performance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="performance-content">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <!-- View Cached Question Modal -->
  <div class="modal fade" id="viewCacheModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cached Question Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="cache-modal-content">
          Loading...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Learner Q&A History Modal -->
  <div class="modal fade" id="learnerHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="learnerHistoryTitle">Learner Q&A History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="learner-history-content" style="max-height: 70vh; overflow-y: auto;">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    let currentUser = null;
    let users = [];

    let settingsData = null;
    let selectedModel = null;

    async function init() {
      await updateNavbar();
      currentUser = await requireAuth();
      if (!currentUser) return;

      if (currentUser.role !== 'admin') {
        alert('Admin access required');
        window.location.href = '/';
        return;
      }

      await loadUsers();
      await loadStats();
      await loadCoursePerformance();
      await loadSettings();
      setupEventListeners();
    }

    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users');
        if (!res.ok) throw new Error('Failed to load users');
        users = await res.json();
        renderUsers();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-table').innerHTML =
          '<tr><td colspan="5" class="text-center text-danger">Failed to load users</td></tr>';
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        if (res.ok) {
          const stats = await res.json();
          document.getElementById('stats-badge').innerHTML =
            `<span class="badge bg-primary me-2">${stats.totalUsers} users</span>
             <span class="badge bg-info me-2">${stats.admins} admins</span>
             <span class="badge bg-secondary">${stats.learners} learners</span>`;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Store course data for modals
    let coursePerformanceData = [];

    const TYPE_LABELS = {
      mcq: 'Multiple Choice',
      truefalse: 'True/False',
      concept: 'Concept',
      comparison: 'Comparison',
      fillblank: 'Fill Blank'
    };

    async function loadCoursePerformance() {
      const container = document.getElementById('course-performance-container');
      try {
        const res = await fetch('/api/admin/course-performance');
        if (!res.ok) throw new Error('Failed to load course performance');
        const courses = await res.json();
        coursePerformanceData = courses;

        if (courses.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              No learner activity yet. Performance data will appear here once learners start practicing.
            </div>
          `;
          return;
        }

        container.innerHTML = courses.map((course, courseIndex) => {
          const s = course.summary;
          const topicEntries = Object.entries(s.byTopic);
          const typeEntries = Object.entries(s.byType);

          return `
          <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">${escapeHtml(course.courseName)}</h5>
              <span class="badge bg-light text-primary">${s.activeLearners} Learner${s.activeLearners !== 1 ? 's' : ''}</span>
            </div>
            <div class="card-body">
              <!-- Course Summary -->
              <div class="row g-3 mb-4">
                <div class="col-md-3">
                  <div class="card bg-light text-center">
                    <div class="card-body py-3">
                      <h4 class="mb-0">${s.totalQuestions}</h4>
                      <small class="text-muted">Total Questions</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-light text-center">
                    <div class="card-body py-3">
                      <h4 class="mb-0 text-success">${s.totalCorrect}</h4>
                      <small class="text-muted">Correct Answers</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-light text-center">
                    <div class="card-body py-3">
                      <h4 class="mb-0 ${s.averageScore >= 70 ? 'text-success' : s.averageScore >= 50 ? 'text-warning' : 'text-danger'}">${s.averageScore}%</h4>
                      <small class="text-muted">Average Score</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-light text-center">
                    <div class="card-body py-3">
                      <h4 class="mb-0">${Math.round(s.totalCorrect / s.totalQuestions * 100)}%</h4>
                      <small class="text-muted">Accuracy Rate</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Topic & Type Breakdown -->
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header py-2"><strong>Performance by Topic</strong></div>
                    <div class="card-body p-2">
                      ${topicEntries.length > 0 ? topicEntries.map(([topicId, t]) => `
                        <div class="mb-2">
                          <div class="d-flex justify-content-between small mb-1">
                            <span>${escapeHtml(t.name)}</span>
                            <span>${t.correct}/${t.attempts} (${t.averageScore}%)</span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${t.averageScore >= 70 ? 'bg-success' : t.averageScore >= 50 ? 'bg-warning' : 'bg-danger'}" style="width: ${t.averageScore}%"></div>
                          </div>
                        </div>
                      `).join('') : '<p class="text-muted small mb-0">No topic data</p>'}
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header py-2"><strong>Performance by Question Type</strong></div>
                    <div class="card-body p-2">
                      ${typeEntries.length > 0 ? typeEntries.map(([type, t]) => `
                        <div class="mb-2">
                          <div class="d-flex justify-content-between small mb-1">
                            <span>${TYPE_LABELS[type] || type}</span>
                            <span>${t.correct}/${t.attempts} (${t.averageScore}%)</span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${t.averageScore >= 70 ? 'bg-success' : t.averageScore >= 50 ? 'bg-warning' : 'bg-danger'}" style="width: ${t.averageScore}%"></div>
                          </div>
                        </div>
                      `).join('') : '<p class="text-muted small mb-0">No type data</p>'}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Learners Table -->
              <h6 class="mb-3">Learner Performance</h6>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Learner</th>
                      <th class="text-center">Questions</th>
                      <th class="text-center">Correct</th>
                      <th class="text-center">Avg Score</th>
                      <th>Last Activity</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${course.learners.map((learner, learnerIndex) => `
                      <tr>
                        <td>
                          <div>${escapeHtml(learner.name)}</div>
                          <small class="text-muted">${escapeHtml(learner.email)}</small>
                        </td>
                        <td class="text-center">${learner.attempts}</td>
                        <td class="text-center">
                          <span class="badge ${learner.correct === learner.attempts ? 'bg-success' : learner.correct > learner.attempts / 2 ? 'bg-info' : 'bg-warning'}">
                            ${learner.correct} / ${learner.attempts}
                          </span>
                        </td>
                        <td class="text-center">
                          <span class="badge ${learner.averageScore >= 80 ? 'bg-success' : learner.averageScore >= 60 ? 'bg-info' : 'bg-warning'}">
                            ${learner.averageScore}%
                          </span>
                        </td>
                        <td>${learner.lastActivity ? new Date(learner.lastActivity).toLocaleString() : 'N/A'}</td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewLearnerDetails(${courseIndex}, ${learnerIndex})">
                              Details
                            </button>
                            <button class="btn btn-outline-primary" onclick="viewLearnerHistory(${learner.id}, '${escapeJs(course.courseId)}', '${escapeJs(learner.name)}', '${escapeJs(course.courseName)}')">
                              Q&A
                            </button>
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `}).join('');
      } catch (error) {
        console.error('Error loading course performance:', error);
        container.innerHTML = '<div class="alert alert-danger">Failed to load course performance</div>';
      }
    }

    function viewLearnerDetails(courseIndex, learnerIndex) {
      const course = coursePerformanceData[courseIndex];
      const learner = course.learners[learnerIndex];

      const topicEntries = Object.entries(learner.byTopic || {});
      const typeEntries = Object.entries(learner.byType || {});

      const content = document.getElementById('performance-content');
      content.innerHTML = `
        <div class="mb-3">
          <h5>${escapeHtml(learner.name)}</h5>
          <p class="text-muted mb-0">${escapeHtml(learner.email)}</p>
          <p class="text-muted small">Course: ${escapeHtml(course.courseName)}</p>
        </div>

        <div class="row g-3 mb-4 text-center">
          <div class="col-4">
            <div class="p-3 bg-light rounded">
              <h3 class="mb-0">${learner.attempts}</h3>
              <small class="text-muted">Questions</small>
            </div>
          </div>
          <div class="col-4">
            <div class="p-3 bg-light rounded">
              <h3 class="mb-0 text-success">${learner.correct}</h3>
              <small class="text-muted">Correct</small>
            </div>
          </div>
          <div class="col-4">
            <div class="p-3 bg-light rounded">
              <h3 class="mb-0 ${learner.averageScore >= 70 ? 'text-success' : learner.averageScore >= 50 ? 'text-warning' : 'text-danger'}">${learner.averageScore}%</h3>
              <small class="text-muted">Avg Score</small>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header py-2"><strong>By Topic</strong></div>
              <div class="card-body p-2">
                ${topicEntries.length > 0 ? `
                  <table class="table table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Topic</th>
                        <th class="text-center">Score</th>
                        <th class="text-center">Correct</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${topicEntries.map(([topicId, t]) => `
                        <tr>
                          <td>${escapeHtml(t.name)}</td>
                          <td class="text-center">
                            <span class="badge ${t.averageScore >= 70 ? 'bg-success' : t.averageScore >= 50 ? 'bg-warning' : 'bg-danger'}">${t.averageScore}%</span>
                          </td>
                          <td class="text-center">${t.correct}/${t.attempts}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                ` : '<p class="text-muted mb-0">No topic data</p>'}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header py-2"><strong>By Question Type</strong></div>
              <div class="card-body p-2">
                ${typeEntries.length > 0 ? `
                  <table class="table table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Type</th>
                        <th class="text-center">Score</th>
                        <th class="text-center">Correct</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${typeEntries.map(([type, t]) => `
                        <tr>
                          <td>${TYPE_LABELS[type] || type}</td>
                          <td class="text-center">
                            <span class="badge ${t.averageScore >= 70 ? 'bg-success' : t.averageScore >= 50 ? 'bg-warning' : 'bg-danger'}">${t.averageScore}%</span>
                          </td>
                          <td class="text-center">${t.correct}/${t.attempts}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                ` : '<p class="text-muted mb-0">No type data</p>'}
              </div>
            </div>
          </div>
        </div>

        ${learner.lastActivity ? `<p class="text-muted small mt-3 mb-0">Last activity: ${new Date(learner.lastActivity).toLocaleString()}</p>` : ''}
      `;

      new bootstrap.Modal(document.getElementById('viewPerformanceModal')).show();
    }

    function renderUsers() {
      const tbody = document.getElementById('users-table');
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const isEnabled = user.enabled === 1 || user.enabled === true;
        const isEmailVerified = user.email_verified === 1 || user.email_verified === true;
        const isCurrentUser = user.id === currentUser.id;

        let statusBadges = '';
        if (isEnabled) {
          statusBadges += '<span class="badge bg-success me-1">Enabled</span>';
        } else {
          statusBadges += '<span class="badge bg-danger me-1">Disabled</span>';
        }
        if (isEmailVerified) {
          statusBadges += '<span class="badge bg-info">Verified</span>';
        } else {
          statusBadges += '<span class="badge bg-warning">Unverified</span>';
        }

        return `
          <tr class="${!isEnabled ? 'table-secondary' : ''}">
            <td>${escapeHtml(user.name)}</td>
            <td>${escapeHtml(user.email)}</td>
            <td>
              <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">
                ${user.role}
              </span>
            </td>
            <td>${statusBadges}</td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editUser(${user.id})">Edit</button>
                <button class="btn btn-outline-info" onclick="viewPerformance(${user.id})">Stats</button>
                ${!isCurrentUser ? `
                  <button class="btn ${isEnabled ? 'btn-outline-warning' : 'btn-outline-success'}" onclick="toggleUserEnabled(${user.id}, ${!isEnabled})">
                    ${isEnabled ? 'Disable' : 'Enable'}
                  </button>
                  <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})">Delete</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeJs(text) {
      return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function editUser(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      const isCurrentUser = user.id === currentUser.id;

      document.getElementById('edit-user-id').value = user.id;
      document.getElementById('edit-name').value = user.name;
      document.getElementById('edit-email').value = user.email;
      document.getElementById('edit-role').value = user.role;
      document.getElementById('edit-enabled').checked = user.enabled === 1 || user.enabled === true;

      // Disable role and enabled change for current user
      document.getElementById('edit-role').disabled = isCurrentUser;
      document.getElementById('edit-enabled').disabled = isCurrentUser;

      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    async function saveUser() {
      const userId = document.getElementById('edit-user-id').value;
      const name = document.getElementById('edit-name').value;
      const email = document.getElementById('edit-email').value;
      const role = document.getElementById('edit-role').value;
      const enabled = document.getElementById('edit-enabled').checked;

      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, role, enabled })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to update user');
        }

        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        await loadUsers();
        await loadStats();
      } catch (error) {
        alert(error.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to delete user');
        }

        await loadUsers();
        await loadStats();
        await loadCoursePerformance();
      } catch (error) {
        alert(error.message);
      }
    }

    async function toggleUserEnabled(userId, enabled) {
      const action = enabled ? 'enable' : 'disable';
      if (!confirm(`Are you sure you want to ${action} this user?`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || `Failed to ${action} user`);
        }

        await loadUsers();
        await loadStats();
      } catch (error) {
        alert(error.message);
      }
    }

    async function viewPerformance(userId) {
      const content = document.getElementById('performance-content');
      content.innerHTML = 'Loading...';

      new bootstrap.Modal(document.getElementById('viewPerformanceModal')).show();

      try {
        const res = await fetch(`/api/admin/users/${userId}/performance`);
        if (!res.ok) throw new Error('Failed to load performance');

        const data = await res.json();

        content.innerHTML = `
          <h6>${escapeHtml(data.user.name)} (${escapeHtml(data.user.email)})</h6>
          <hr>
          <div class="row mb-3">
            <div class="col-4 text-center">
              <h3>${data.stats.totalQuestions || 0}</h3>
              <small class="text-muted">Questions</small>
            </div>
            <div class="col-4 text-center">
              <h3>${data.stats.correctAnswers || 0}</h3>
              <small class="text-muted">Correct</small>
            </div>
            <div class="col-4 text-center">
              <h3>${Math.round(data.stats.averageScore || 0)}%</h3>
              <small class="text-muted">Avg Score</small>
            </div>
          </div>
          ${data.recent.length > 0 ? `
            <h6>Recent Activity</h6>
            <ul class="list-group list-group-flush">
              ${data.recent.slice(0, 10).map(p => `
                <li class="list-group-item d-flex justify-content-between">
                  <span>${p.topic_id || 'Unknown Topic'} - ${p.question_type || 'Unknown Type'}</span>
                  <span class="badge ${p.is_correct ? 'bg-success' : 'bg-danger'}">${p.score}%</span>
                </li>
              `).join('')}
            </ul>
          ` : '<p class="text-muted">No activity yet</p>'}
        `;
      } catch (error) {
        content.innerHTML = '<p class="text-danger">Failed to load performance</p>';
      }
    }

    async function viewLearnerHistory(userId, courseId, learnerName, courseName) {
      const content = document.getElementById('learner-history-content');
      document.getElementById('learnerHistoryTitle').textContent = learnerName + ' - ' + courseName + ' Q&A History';
      content.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p>Loading history...</p></div>';

      new bootstrap.Modal(document.getElementById('learnerHistoryModal')).show();

      try {
        const res = await fetch('/api/admin/users/' + userId + '/history?courseId=' + courseId);
        if (!res.ok) throw new Error('Failed to load history');

        const data = await res.json();

        if (!data.history || data.history.length === 0) {
          content.innerHTML = '<div class="alert alert-info">No Q&A history found for this learner in this course.</div>';
          return;
        }

        const typeLabels = {
          mcq: 'Multiple Choice',
          truefalse: 'True/False',
          concept: 'Concept',
          comparison: 'Comparison',
          fillblank: 'Fill Blank'
        };

        const correctCount = data.history.filter(h => h.result.isCorrect).length;
        const incorrectCount = data.history.length - correctCount;

        let html = '<div class="mb-3">' +
          '<span class="badge bg-primary me-2">' + data.history.length + ' Questions</span>' +
          '<span class="badge bg-success me-2">' + correctCount + ' Correct</span>' +
          '<span class="badge bg-danger">' + incorrectCount + ' Incorrect</span>' +
          '</div>' +
          '<div class="accordion" id="historyAccordion">';

        data.history.forEach((item, index) => {
          const q = item.question_data;
          const r = item.result;
          const isCorrect = r.isCorrect;
          const date = new Date(item.created_at).toLocaleString();

          let answerDisplay = '';
          if (q.type === 'mcq' && q.options) {
            const userIdx = parseInt(item.user_answer);
            answerDisplay = '<div class="mb-2"><strong>Options:</strong><ul class="mb-0">';
            q.options.forEach((opt, i) => {
              let cls = '';
              let prefix = '';
              if (i === q.correctAnswer) { cls = 'text-success fw-bold'; prefix = ' '; }
              if (i === userIdx && i !== q.correctAnswer) { cls = 'text-danger'; prefix = ' '; }
              if (i === userIdx) { prefix += '(Learner) '; }
              answerDisplay += '<li class="' + cls + '">' + prefix + escapeHtml(opt) + '</li>';
            });
            answerDisplay += '</ul></div>';
          } else if (q.type === 'truefalse') {
            answerDisplay = '<p><strong>Correct Answer:</strong> <span class="text-success">' + (q.correctAnswer ? 'True' : 'False') + '</span></p>' +
              '<p><strong>Learner\'s Answer:</strong> <span class="' + (isCorrect ? 'text-success' : 'text-danger') + '">' + (item.user_answer === 'true' ? 'True' : 'False') + '</span></p>';
          } else if (q.type === 'fillblank') {
            answerDisplay = '<p><strong>Correct Answer:</strong> <span class="text-success">' + escapeHtml(q.correctAnswer || '') + '</span></p>' +
              '<p><strong>Learner\'s Answer:</strong> <span class="' + (isCorrect ? 'text-success' : 'text-danger') + '">' + escapeHtml(item.user_answer) + '</span></p>';
          } else {
            answerDisplay = '<div class="mb-2"><strong>Learner\'s Answer:</strong><div class="bg-light p-2 rounded mt-1">' + escapeHtml(item.user_answer) + '</div></div>';
            if (q.sampleAnswer) {
              answerDisplay += '<div class="mb-2"><strong>Sample Answer:</strong><div class="bg-light p-2 rounded mt-1">' + escapeHtml(q.sampleAnswer) + '</div></div>';
            }
          }

          html += '<div class="accordion-item">' +
            '<h2 class="accordion-header">' +
            '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#history-' + index + '">' +
            '<span class="me-2 ' + (isCorrect ? 'text-success' : 'text-danger') + '">' + (isCorrect ? '' : '') + '</span>' +
            '<span class="badge bg-secondary me-2">' + (typeLabels[q.type] || q.type) + '</span>' +
            '<span class="badge ' + (isCorrect ? 'bg-success' : 'bg-danger') + ' me-2">' + r.score + '%</span>' +
            '<span class="text-truncate" style="max-width: 400px;">' + escapeHtml(q.question) + '</span>' +
            '<small class="text-muted ms-auto me-3">' + date + '</small>' +
            '</button></h2>' +
            '<div id="history-' + index + '" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">' +
            '<div class="accordion-body">' +
            '<div class="mb-3"><strong>Question:</strong><p class="mb-0">' + escapeHtml(q.question) + '</p></div>' +
            answerDisplay +
            '<div class="alert ' + (isCorrect ? 'alert-success' : 'alert-info') + ' mb-2">' +
            '<strong>Feedback:</strong> ' + escapeHtml(r.feedback || q.explanation || 'No feedback available') + '</div>';

          if (r.strengths && r.strengths.length > 0) {
            html += '<div class="mt-2"><strong class="text-success">Strengths:</strong><ul class="mb-0">';
            r.strengths.forEach(s => { html += '<li>' + escapeHtml(s) + '</li>'; });
            html += '</ul></div>';
          }
          if (r.missingPoints && r.missingPoints.length > 0) {
            html += '<div class="mt-2"><strong class="text-warning">Areas to Improve:</strong><ul class="mb-0">';
            r.missingPoints.forEach(m => { html += '<li>' + escapeHtml(m) + '</li>'; });
            html += '</ul></div>';
          }

          html += '</div></div></div>';
        });

        html += '</div>';
        content.innerHTML = html;
      } catch (error) {
        console.error('Error loading learner history:', error);
        content.innerHTML = '<div class="alert alert-danger">Failed to load Q&A history</div>';
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/admin/settings');
        if (!res.ok) throw new Error('Failed to load settings');

        settingsData = await res.json();
        selectedModel = settingsData.settings.ai_model;

        // Update current model badge
        document.getElementById('current-model-badge').textContent = settingsData.currentModel.name;

        // Update email verification toggle
        const emailVerificationEnabled = settingsData.settings.require_email_verification === 'true' || settingsData.settings.require_email_verification === '1';
        document.getElementById('require-email-verification').checked = emailVerificationEnabled;

        // Update interview requirements
        document.getElementById('interview-min-questions').value = parseInt(settingsData.settings.interview_min_questions) || 0;
        document.getElementById('interview-min-score').value = parseInt(settingsData.settings.interview_min_score) || 0;
        document.getElementById('interview-daily-limit').value = parseInt(settingsData.settings.interview_daily_question_limit) || 50;

        // Update question types
        const enabledTypes = settingsData.settings.enabled_question_types
          ? JSON.parse(settingsData.settings.enabled_question_types)
          : ['mcq', 'truefalse', 'concept', 'comparison', 'fillblank'];
        document.querySelectorAll('.question-type-check').forEach(cb => {
          cb.checked = enabledTypes.includes(cb.value);
        });

        // Update allow question type selection toggle
        const allowSelection = settingsData.settings.allow_question_type_selection === 'true';
        document.getElementById('allow-question-type-selection').checked = allowSelection;

        // Update require user API keys toggle
        const requireUserApiKeys = settingsData.settings.require_user_api_keys === 'true';
        document.getElementById('require-user-api-keys').checked = requireUserApiKeys;

        // Update allow clear history toggle (default: false)
        const allowClearHistory = settingsData.settings.allow_clear_history === 'true';
        document.getElementById('allow-clear-history').checked = allowClearHistory;

        // Render model options
        renderModelOptions();

        // Check API key status
        checkApiKeyStatus();
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    async function saveEmailSettings() {
      const btn = document.getElementById('save-email-settings-btn');
      const status = document.getElementById('email-settings-status');
      const enabled = document.getElementById('require-email-verification').checked;

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ require_email_verification: enabled ? 'true' : 'false' })
        });

        if (!res.ok) throw new Error('Failed to save settings');

        status.innerHTML = '<span class="text-success">Saved!</span>';
        setTimeout(() => { status.textContent = ''; }, 3000);
      } catch (error) {
        console.error('Error saving email settings:', error);
        status.innerHTML = '<span class="text-danger">Error saving</span>';
      }

      btn.disabled = false;
    }

    async function saveInterviewSettings() {
      const btn = document.getElementById('save-interview-settings-btn');
      const status = document.getElementById('interview-settings-status');
      const minQuestions = document.getElementById('interview-min-questions').value;
      const minScore = document.getElementById('interview-min-score').value;
      const dailyLimit = document.getElementById('interview-daily-limit').value;

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            interview_min_questions: minQuestions,
            interview_min_score: minScore,
            interview_daily_question_limit: dailyLimit
          })
        });

        if (!res.ok) throw new Error('Failed to save settings');

        status.innerHTML = '<span class="text-success">Saved!</span>';
        setTimeout(() => { status.textContent = ''; }, 3000);
      } catch (error) {
        console.error('Error saving interview settings:', error);
        status.innerHTML = '<span class="text-danger">Error saving</span>';
      }

      btn.disabled = false;
    }

    async function saveQuestionTypes() {
      const btn = document.getElementById('save-question-types-btn');
      const status = document.getElementById('question-types-status');

      const enabledTypes = [];
      document.querySelectorAll('.question-type-check:checked').forEach(cb => {
        enabledTypes.push(cb.value);
      });

      if (enabledTypes.length === 0) {
        status.innerHTML = '<span class="text-danger">At least one type must be enabled</span>';
        return;
      }

      const allowSelection = document.getElementById('allow-question-type-selection').checked;

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            enabled_question_types: enabledTypes,
            allow_question_type_selection: allowSelection
          })
        });

        if (!res.ok) throw new Error('Failed to save settings');

        status.innerHTML = '<span class="text-success">Saved!</span>';
        setTimeout(() => { status.textContent = ''; }, 3000);
      } catch (error) {
        console.error('Error saving question types:', error);
        status.innerHTML = '<span class="text-danger">Error saving</span>';
      }

      btn.disabled = false;
    }

    async function saveUserApiSettings() {
      const btn = document.getElementById('save-user-api-settings-btn');
      const status = document.getElementById('user-api-settings-status');
      const requireUserApiKeys = document.getElementById('require-user-api-keys').checked;

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ require_user_api_keys: requireUserApiKeys })
        });

        if (!res.ok) throw new Error('Failed to save settings');

        status.innerHTML = '<span class="text-success">Saved!</span>';
        setTimeout(() => { status.textContent = ''; }, 3000);
      } catch (error) {
        console.error('Error saving user API settings:', error);
        status.innerHTML = '<span class="text-danger">Error saving</span>';
      }

      btn.disabled = false;
    }

    async function saveLearnerFeatures() {
      const btn = document.getElementById('save-learner-features-btn');
      const status = document.getElementById('learner-features-status');
      const allowClearHistory = document.getElementById('allow-clear-history').checked;

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allow_clear_history: allowClearHistory })
        });

        if (!res.ok) throw new Error('Failed to save settings');

        status.innerHTML = '<span class="text-success">Saved!</span>';
        setTimeout(() => { status.textContent = ''; }, 3000);
      } catch (error) {
        console.error('Error saving learner features:', error);
        status.innerHTML = '<span class="text-danger">Error saving</span>';
      }

      btn.disabled = false;
    }

    function renderModelOptions() {
      const container = document.getElementById('model-options');

      // Group models by provider
      const groqModels = settingsData.availableModels.filter(m => m.provider === 'groq');
      const anthropicModels = settingsData.availableModels.filter(m => m.provider === 'anthropic');

      let html = '';

      // Groq models
      html += '<div class="mb-3"><h6 class="text-muted">Groq (Free)</h6>';
      groqModels.forEach(model => {
        const isSelected = model.key === selectedModel;
        html += '<div class="form-check mb-2">' +
          '<input class="form-check-input model-radio" type="radio" name="ai-model" id="model-' + model.key.replace(':', '-') + '" value="' + model.key + '"' + (isSelected ? ' checked' : '') + '>' +
          '<label class="form-check-label" for="model-' + model.key.replace(':', '-') + '">' +
          model.name +
          '</label></div>';
      });
      html += '</div>';

      // Anthropic models
      html += '<div class="mb-3"><h6 class="text-muted">Anthropic (Claude)</h6>';
      anthropicModels.forEach(model => {
        const isSelected = model.key === selectedModel;
        html += '<div class="form-check mb-2">' +
          '<input class="form-check-input model-radio" type="radio" name="ai-model" id="model-' + model.key.replace(':', '-') + '" value="' + model.key + '"' + (isSelected ? ' checked' : '') + '>' +
          '<label class="form-check-label" for="model-' + model.key.replace(':', '-') + '">' +
          model.name +
          '</label></div>';
      });
      html += '</div>';

      container.innerHTML = html;

      // Add change listeners
      document.querySelectorAll('.model-radio').forEach(radio => {
        radio.addEventListener('change', (e) => {
          selectedModel = e.target.value;
          document.getElementById('save-settings-btn').disabled = false;
          document.getElementById('settings-save-status').textContent = '';
        });
      });
    }

    async function saveSettings() {
      const btn = document.getElementById('save-settings-btn');
      const status = document.getElementById('settings-save-status');

      btn.disabled = true;
      status.innerHTML = '<span class="text-muted">Saving...</span>';

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ai_model: selectedModel })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to save settings');
        }

        const data = await res.json();
        settingsData.currentModel = data.currentModel;
        document.getElementById('current-model-badge').textContent = data.currentModel.name;
        status.innerHTML = '<span class="text-success">Settings saved!</span>';

        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('Error saving settings:', error);
        status.innerHTML = '<span class="text-danger">Error: ' + error.message + '</span>';
        btn.disabled = false;
      }
    }

    async function checkApiKeyStatus() {
      try {
        const res = await fetch('/api/admin/api-keys-status');
        if (res.ok) {
          const data = await res.json();
          updateApiKeysTable(data);
        }
      } catch (error) {
        // API endpoint might not exist yet, that's ok
        console.log('Could not check API key status');
      }
    }

    function updateApiKeysTable(status) {
      const tbody = document.getElementById('api-keys-status');
      tbody.innerHTML = '<tr>' +
        '<td>Groq</td>' +
        '<td><code>GROQ_API_KEY</code></td>' +
        '<td><span class="badge ' + (status.groq ? 'bg-success">Configured' : 'bg-warning">Not Set') + '</span></td>' +
        '</tr>' +
        '<tr>' +
        '<td>Anthropic (Claude)</td>' +
        '<td><code>ANTHROPIC_API_KEY</code></td>' +
        '<td><span class="badge ' + (status.anthropic ? 'bg-success">Configured' : 'bg-warning">Not Set') + '</span></td>' +
        '</tr>';
    }

    // ============================================================
    // DISPUTES MANAGEMENT
    // ============================================================

    let adminDisputesData = [];

    async function loadAdminDisputesBadge() {
      try {
        const res = await fetch('/api/admin/disputes?status=pending');
        if (res.ok) {
          const data = await res.json();
          const count = data.disputes.length;
          const badge = document.getElementById('admin-disputes-badge');
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading disputes badge:', error);
      }
    }

    async function loadAdminDisputes() {
      const container = document.getElementById('admin-disputes-list');
      const filter = document.getElementById('admin-dispute-filter').value;

      container.innerHTML = '<p class="text-center py-4">Loading disputes...</p>';

      try {
        const url = filter ? `/api/admin/disputes?status=${filter}` : '/api/admin/disputes';
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to load disputes');

        const data = await res.json();
        adminDisputesData = data.disputes || [];

        renderAdminDisputes();
      } catch (error) {
        console.error('Error loading disputes:', error);
        container.innerHTML = '<div class="alert alert-danger">Failed to load disputes</div>';
      }
    }

    function renderAdminDisputes() {
      const container = document.getElementById('admin-disputes-list');

      if (adminDisputesData.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">No disputes found</p>';
        return;
      }

      const html = adminDisputesData.map(d => {
        const statusBadge = d.status === 'pending' ? 'bg-warning text-dark' :
                            d.status === 'approved' ? 'bg-success' : 'bg-danger';
        const statusText = d.status.charAt(0).toUpperCase() + d.status.slice(1);
        const dateStr = new Date(d.created_at).toLocaleString();
        const q = d.question_data;

        const actionButtons = d.status === 'pending' ? `
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-success btn-sm" onclick="approveDispute(${d.id})">
                Approve & Re-evaluate
              </button>
              <button class="btn btn-danger btn-sm" onclick="showDisapproveForm(${d.id})">
                Disapprove
              </button>
            </div>
            <div id="disapprove-form-${d.id}" class="mt-3" style="display: none;">
              <textarea id="disapprove-reason-${d.id}" class="form-control mb-2" rows="2"
                placeholder="Explain why the dispute is being rejected..."></textarea>
              <div class="d-flex gap-2">
                <button class="btn btn-danger btn-sm" onclick="disapproveDispute(${d.id})">Confirm Disapproval</button>
                <button class="btn btn-secondary btn-sm" onclick="hideDisapproveForm(${d.id})">Cancel</button>
              </div>
            </div>
          </div>
        ` : '';

        return `
          <div class="card mb-3 ${d.status === 'pending' ? 'border-warning' : ''}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span class="badge ${statusBadge} me-2">${statusText}</span>
                  <span class="badge bg-info me-2">${TYPE_LABELS[q.type] || q.type}</span>
                  <span class="badge bg-secondary">${q.topicName || d.topic_id}</span>
                </div>
                <div>
                  <span class="badge bg-dark">Original: ${d.original_score}%</span>
                  ${d.new_score !== null ? `<span class="badge bg-success ms-1">New: ${d.new_score}%</span>` : ''}
                </div>
              </div>

              <div class="mb-2">
                <small class="text-muted">Learner:</small>
                <strong>${escapeHtml(d.user_name)}</strong>
                <small class="text-muted">(${escapeHtml(d.user_email)})</small>
                <span class="text-muted ms-2">|</span>
                <small class="text-muted ms-2">${dateStr}</small>
              </div>

              <h6 class="mb-2">${escapeHtml(q.question)}</h6>

              <div class="row g-2 mb-2">
                <div class="col-md-6">
                  <div class="bg-light p-2 rounded">
                    <small class="text-muted">Learner's answer:</small>
                    <p class="mb-0 small">${escapeHtml(d.user_answer)}</p>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="bg-warning bg-opacity-10 p-2 rounded">
                    <small class="text-muted">Dispute reason:</small>
                    <p class="mb-0 small">${escapeHtml(d.dispute_reason)}</p>
                  </div>
                </div>
              </div>

              <div class="bg-info bg-opacity-10 p-2 rounded mb-2">
                <small class="text-muted">AI Feedback:</small>
                <p class="mb-0 small">${escapeHtml(d.result.feedback || 'No feedback available')}</p>
              </div>

              ${d.admin_comments ? `
                <div class="bg-secondary bg-opacity-10 p-2 rounded">
                  <small class="text-muted">Admin response:</small>
                  <p class="mb-0 small">${escapeHtml(d.admin_comments)}</p>
                </div>
              ` : ''}

              ${actionButtons}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function showDisapproveForm(disputeId) {
      document.getElementById(`disapprove-form-${disputeId}`).style.display = 'block';
    }

    function hideDisapproveForm(disputeId) {
      document.getElementById(`disapprove-form-${disputeId}`).style.display = 'none';
    }

    async function approveDispute(disputeId) {
      if (!confirm('Approve this dispute and re-evaluate the answer with AI? This may change the learner\'s score.')) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/disputes/${disputeId}/approve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (res.ok) {
          alert(`Dispute approved! New score: ${data.newScore}%`);
          loadAdminDisputes();
          loadAdminDisputesBadge();
        } else {
          alert(data.error || 'Failed to approve dispute');
        }
      } catch (error) {
        console.error('Error approving dispute:', error);
        alert('Failed to approve dispute');
      }
    }

    async function disapproveDispute(disputeId) {
      const reason = document.getElementById(`disapprove-reason-${disputeId}`).value.trim();

      if (reason.length < 10) {
        alert('Please provide a more detailed reason for disapproval (at least 10 characters).');
        return;
      }

      try {
        const res = await fetch(`/api/admin/disputes/${disputeId}/disapprove`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminComments: reason })
        });

        const data = await res.json();

        if (res.ok) {
          alert('Dispute disapproved.');
          loadAdminDisputes();
          loadAdminDisputesBadge();
        } else {
          alert(data.error || 'Failed to disapprove dispute');
        }
      } catch (error) {
        console.error('Error disapproving dispute:', error);
        alert('Failed to disapprove dispute');
      }
    }

    // ============================================================
    // CACHE MANAGEMENT
    // ============================================================

    let cacheData = { stats: [], questions: [] };
    let filteredCacheData = [];
    let cacheCurrentPage = 1;

    async function loadCache() {
      const tbody = document.getElementById('cache-table');
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Loading cache...</td></tr>';

      try {
        const res = await fetch('/api/admin/cache');
        if (!res.ok) throw new Error('Failed to load cache');

        cacheData = await res.json();
        renderCacheStats();
        populateCacheFilters();
        applyCacheFilters();
      } catch (error) {
        console.error('Error loading cache:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load cache</td></tr>';
      }
    }

    function populateCacheFilters() {
      const questions = cacheData.questions || [];

      // Populate course filter
      const courses = [...new Set(questions.map(q => q.course_id))].sort();
      const courseSelect = document.getElementById('cache-filter-course');
      const currentCourse = courseSelect.value;
      courseSelect.innerHTML = '<option value="">All Courses</option>' +
        courses.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      courseSelect.value = currentCourse;

      // Populate topic filter
      const topics = [...new Set(questions.map(q => q.topic_id))].sort();
      const topicSelect = document.getElementById('cache-filter-topic');
      const currentTopic = topicSelect.value;
      topicSelect.innerHTML = '<option value="">All Topics</option>' +
        topics.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      topicSelect.value = currentTopic;
    }

    function applyCacheFilters() {
      const courseFilter = document.getElementById('cache-filter-course').value;
      const topicFilter = document.getElementById('cache-filter-topic').value;
      const typeFilter = document.getElementById('cache-filter-type').value;

      filteredCacheData = (cacheData.questions || []).filter(q => {
        if (courseFilter && q.course_id !== courseFilter) return false;
        if (topicFilter && q.topic_id !== topicFilter) return false;
        if (typeFilter && q.question_type !== typeFilter) return false;
        return true;
      });

      // Update filter count
      const total = cacheData.questions?.length || 0;
      const filtered = filteredCacheData.length;
      document.getElementById('cache-filter-count').textContent =
        filtered === total ? `${total} questions` : `${filtered} of ${total}`;

      cacheCurrentPage = 1;
      renderCacheTable();
      renderCachePagination();
    }

    function resetCacheFilters() {
      document.getElementById('cache-filter-course').value = '';
      document.getElementById('cache-filter-topic').value = '';
      document.getElementById('cache-filter-type').value = '';
      applyCacheFilters();
    }

    function renderCacheStats() {
      const stats = cacheData.stats || [];
      const questions = cacheData.questions || [];

      const totalQuestions = questions.length;
      const uniqueCourses = new Set(questions.map(q => q.course_id)).size;
      const uniqueTopics = new Set(questions.map(q => q.topic_id)).size;
      const uniqueTypes = new Set(questions.map(q => q.question_type)).size;

      document.getElementById('cache-total').textContent = totalQuestions;
      document.getElementById('cache-courses').textContent = uniqueCourses;
      document.getElementById('cache-topics').textContent = uniqueTopics;
      document.getElementById('cache-types').textContent = uniqueTypes;
    }

    function renderCacheTable() {
      const tbody = document.getElementById('cache-table');
      const pageSize = parseInt(document.getElementById('cache-page-size').value) || 25;
      const startIndex = (cacheCurrentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = filteredCacheData.slice(startIndex, endIndex);

      if (filteredCacheData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No cached questions</td></tr>';
        return;
      }

      tbody.innerHTML = pageData.map((q) => {
        const questionText = q.questionData?.question || 'N/A';
        const preview = questionText.length > 60 ? questionText.substring(0, 60) + '...' : questionText;
        const dateStr = new Date(q.created_at).toLocaleString();
        const originalIndex = filteredCacheData.indexOf(q);

        return `
          <tr>
            <td>${q.id}</td>
            <td><span class="badge bg-primary">${escapeHtml(q.course_id)}</span></td>
            <td>${escapeHtml(q.topic_id)}</td>
            <td><span class="badge bg-secondary">${TYPE_LABELS[q.question_type] || q.question_type}</span></td>
            <td title="${escapeHtml(questionText)}">${escapeHtml(preview)}</td>
            <td><small>${dateStr}</small></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="viewCachedQuestion(${originalIndex})">View</button>
                <button class="btn btn-outline-danger" onclick="deleteCachedQuestion(${q.id})">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderCachePagination() {
      const pagination = document.getElementById('cache-pagination');
      const pageSize = parseInt(document.getElementById('cache-page-size').value) || 25;
      const totalPages = Math.ceil(filteredCacheData.length / pageSize);

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      html += `<li class="page-item ${cacheCurrentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToCachePage(${cacheCurrentPage - 1}); return false;">Prev</a>
      </li>`;

      // Page numbers
      const maxPages = 5;
      let startPage = Math.max(1, cacheCurrentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToCachePage(1); return false;">1</a></li>`;
        if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === cacheCurrentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="goToCachePage(${i}); return false;">${i}</a>
        </li>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToCachePage(${totalPages}); return false;">${totalPages}</a></li>`;
      }

      // Next button
      html += `<li class="page-item ${cacheCurrentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToCachePage(${cacheCurrentPage + 1}); return false;">Next</a>
      </li>`;

      pagination.innerHTML = html;
    }

    function goToCachePage(page) {
      const pageSize = parseInt(document.getElementById('cache-page-size').value) || 25;
      const totalPages = Math.ceil(filteredCacheData.length / pageSize);
      if (page < 1 || page > totalPages) return;
      cacheCurrentPage = page;
      renderCacheTable();
      renderCachePagination();
    }

    function viewCachedQuestion(index) {
      const q = filteredCacheData[index];
      if (!q) return;

      const qd = q.questionData || {};
      const content = document.getElementById('cache-modal-content');
      const dateStr = new Date(q.created_at).toLocaleString();

      let optionsHtml = '';
      if (qd.options && Array.isArray(qd.options)) {
        optionsHtml = `
          <div class="mb-3">
            <strong>Options:</strong>
            <ul class="mb-0 mt-1">
              ${qd.options.map((opt, i) => `
                <li class="${i === qd.correctAnswer ? 'text-success fw-bold' : ''}">
                  ${i === qd.correctAnswer ? ' ' : ''}${escapeHtml(opt)}
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }

      let answerHtml = '';
      if (qd.type === 'truefalse') {
        answerHtml = `<p><strong>Correct Answer:</strong> <span class="text-success">${qd.correctAnswer ? 'True' : 'False'}</span></p>`;
      } else if (qd.type === 'fillblank' && qd.correctAnswer) {
        answerHtml = `<p><strong>Correct Answer:</strong> <span class="text-success">${escapeHtml(qd.correctAnswer)}</span></p>`;
      } else if (qd.sampleAnswer) {
        answerHtml = `
          <div class="mb-3">
            <strong>Sample Answer:</strong>
            <div class="bg-light p-2 rounded mt-1">${escapeHtml(qd.sampleAnswer)}</div>
          </div>
        `;
      }

      content.innerHTML = `
        <div class="mb-3">
          <span class="badge bg-primary me-2">${escapeHtml(q.course_id)}</span>
          <span class="badge bg-secondary me-2">${escapeHtml(q.topic_id)}</span>
          <span class="badge bg-info">${TYPE_LABELS[q.question_type] || q.question_type}</span>
          <span class="text-muted float-end small">${dateStr}</span>
        </div>

        <div class="mb-3">
          <strong>Question:</strong>
          <div class="bg-light p-3 rounded mt-1">${escapeHtml(qd.question || 'N/A')}</div>
        </div>

        ${optionsHtml}
        ${answerHtml}

        ${qd.explanation ? `
          <div class="mb-3">
            <strong>Explanation:</strong>
            <div class="bg-info bg-opacity-10 p-2 rounded mt-1">${escapeHtml(qd.explanation)}</div>
          </div>
        ` : ''}

        ${qd.subtopic ? `<p class="text-muted small mb-0"><strong>Subtopic:</strong> ${escapeHtml(qd.subtopic)}</p>` : ''}
        <p class="text-muted small mb-0"><strong>Cache ID:</strong> ${q.id} | <strong>Hash:</strong> ${q.question_hash}</p>
      `;

      new bootstrap.Modal(document.getElementById('viewCacheModal')).show();
    }

    async function deleteCachedQuestion(id) {
      if (!confirm('Delete this cached question?')) return;

      try {
        const res = await fetch(`/api/admin/cache/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to delete');
        }
        loadCache();
      } catch (error) {
        console.error('Error deleting cached question:', error);
        alert('Failed to delete cached question');
      }
    }

    async function clearAllCache() {
      if (!confirm('Are you sure you want to clear ALL cached questions? This cannot be undone.')) return;

      try {
        const res = await fetch('/api/admin/cache', { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to clear cache');
        }
        const data = await res.json();
        alert(data.message);
        loadCache();
      } catch (error) {
        console.error('Error clearing cache:', error);
        alert('Failed to clear cache');
      }
    }

    function setupEventListeners() {
      document.getElementById('save-user-btn').addEventListener('click', saveUser);
      document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
      document.getElementById('save-email-settings-btn').addEventListener('click', saveEmailSettings);
      document.getElementById('save-interview-settings-btn').addEventListener('click', saveInterviewSettings);
      document.getElementById('save-question-types-btn').addEventListener('click', saveQuestionTypes);
      document.getElementById('save-user-api-settings-btn').addEventListener('click', saveUserApiSettings);
      document.getElementById('save-learner-features-btn').addEventListener('click', saveLearnerFeatures);

      // Refresh tabs when shown
      document.getElementById('performance-tab').addEventListener('shown.bs.tab', loadCoursePerformance);
      document.getElementById('settings-tab').addEventListener('shown.bs.tab', loadSettings);
      document.getElementById('disputes-tab').addEventListener('shown.bs.tab', loadAdminDisputes);
      document.getElementById('cache-tab').addEventListener('shown.bs.tab', loadCache);
      document.getElementById('admin-dispute-filter').addEventListener('change', loadAdminDisputes);

      // Cache filters
      document.getElementById('cache-filter-course').addEventListener('change', applyCacheFilters);
      document.getElementById('cache-filter-topic').addEventListener('change', applyCacheFilters);
      document.getElementById('cache-filter-type').addEventListener('change', applyCacheFilters);
      document.getElementById('cache-page-size').addEventListener('change', () => {
        cacheCurrentPage = 1;
        renderCacheTable();
        renderCachePagination();
      });
    }

    // Load disputes badge on init
    loadAdminDisputesBadge();

    init();
  </script>
</body>
</html>
